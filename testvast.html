<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>TVMalaysia.live Player + VAST Ads</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="no-referrer">

  <!-- Shaka Player -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.1.1/shaka-player.ui.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.1.1/controls.min.css" crossorigin="anonymous"/>

  <!-- IMA SDK for VAST ads -->
  <script src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      background-color: black;
      height: 100%;
    }
    .watermark-link {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 9999;
      background: #D50000;
      color: white;
      padding: 6px 12px;
      font-size: 14px;
      font-weight: bold;
      border-radius: 4px;
      text-decoration: none;
      font-family: sans-serif;
      animation: pulse 2.5s infinite ease-in-out;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    .watermark-link:hover {
      background: #FF1744;
    }
  </style>
</head>

<body oncontextmenu="return false">

  <!-- ✅ Watermark -->
  <a href="https://www.tvmalaysia.live" target="_blank" class="watermark-link">TVMalaysia.live</a>

  <!-- ✅ Shaka container -->
  <div id="video-container" data-shaka-player-container style="width:100%; height:100%; position:relative;">
    <video id="video" autoplay playsinline data-shaka-player style="width:100%; height:100%;"></video>
  </div>

  <script>
    const vastAdTagUrl = "https://vast.ufouxbwn.com/vast.php?partner_id=1830896&format=2&referrer=tvmalaysia.live";
    const video = document.getElementById('video');
    const container = document.getElementById('video-container');

    // 1️⃣ IMA SDK setup for pre-roll
    const adDisplayContainer = new google.ima.AdDisplayContainer(container, video);
    const adsLoader = new google.ima.AdsLoader(adDisplayContainer);
    const adsRequest = new google.ima.AdsRequest();

    adsRequest.adTagUrl = vastAdTagUrl;
    adsRequest.linearAdSlotWidth = window.innerWidth;
    adsRequest.linearAdSlotHeight = window.innerHeight;
    adsRequest.nonLinearAdSlotWidth = window.innerWidth;
    adsRequest.nonLinearAdSlotHeight = window.innerHeight;

    adsLoader.addEventListener(
      google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,
      (adsManagerLoadedEvent) => {
        const adsManager = adsManagerLoadedEvent.getAdsManager(video);
        adsManager.addEventListener(google.ima.AdEvent.Type.ALL_ADS_COMPLETED, startShaka);
        adsManager.addEventListener(google.ima.AdEvent.Type.SKIPPED, startShaka);
        adsManager.addEventListener(google.ima.AdEvent.Type.COMPLETE, startShaka);
        adsManager.init(window.innerWidth, window.innerHeight, google.ima.ViewMode.NORMAL);
        adsManager.start();
      },
      false
    );

    adsLoader.addEventListener(
      google.ima.AdErrorEvent.Type.AD_ERROR,
      () => {
        console.warn("⚠️ Ad error, skip to stream...");
        startShaka();
      },
      false
    );

    adDisplayContainer.initialize();
    adsLoader.requestAds(adsRequest);

    // 2️⃣ Init Shaka Player after ad
    async function startShaka() {
      const player = new shaka.Player(video);

      // Unlock stream
      player.configure({
        drm: {
          clearKeys: {
            '92d34a84fae8e54de0a829629941be10': '2fb39ab3f55333d5fa3e830ebf99ec16'
          }
        }
      });

      player.setTextTrackVisibility(true);

      try {
        await player.load("https://linearjitp-playback.astro.com.my/dash-wv/linear/5094/default_ott.mpd");
        console.log("✅ Stream loaded.");
        player.play();
      } catch (e) {
        console.error("❌ Stream error:", e);
      }
    }
  </script>

</body>
</html>
